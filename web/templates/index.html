<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .title }}</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/static/js/version-features.js"></script>
    <script src="/static/js/file-upload-component.js"></script>
    <script src="/static/js/file-upload-ui.js"></script>
</head>
<body class="bg-gray-900 text-white">
    <div x-data="app()" x-init="init()" class="min-h-screen">
        <!-- Login/Register Screen -->
        <div x-show="!isAuthenticated" class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-gray-800 rounded-lg p-8 max-w-md w-full">
                <h1 class="text-4xl font-bold text-green-400 mb-2 text-center">PayPerPlay</h1>
                <p class="text-gray-400 text-center mb-8">Minecraft Hosting - Pay only when you play ‚ö°</p>

                <!-- Tabs -->
                <div class="flex gap-2 mb-6 border-b border-gray-700">
                    <button @click="authTab = 'login'"
                            :class="authTab === 'login' ? 'border-green-400 text-green-400' : 'border-transparent'"
                            class="px-4 py-2 border-b-2 transition font-semibold">
                        Login
                    </button>
                    <button @click="authTab = 'register'"
                            :class="authTab === 'register' ? 'border-green-400 text-green-400' : 'border-transparent'"
                            class="px-4 py-2 border-b-2 transition font-semibold">
                        Register
                    </button>
                </div>

                <!-- Login Form -->
                <form x-show="authTab === 'login'" @submit.prevent="login" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Email</label>
                        <input type="email" x-model="loginForm.email" required
                               class="w-full px-4 py-2 bg-gray-700 rounded border border-gray-600 focus:border-green-400 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Password</label>
                        <input type="password" x-model="loginForm.password" required
                               class="w-full px-4 py-2 bg-gray-700 rounded border border-gray-600 focus:border-green-400 focus:outline-none">
                    </div>
                    <button type="submit"
                            class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded transition">
                        Login
                    </button>
                </form>

                <!-- Register Form -->
                <form x-show="authTab === 'register'" @submit.prevent="register" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Username</label>
                        <input type="text" x-model="registerForm.username" required minlength="3"
                               class="w-full px-4 py-2 bg-gray-700 rounded border border-gray-600 focus:border-green-400 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Email</label>
                        <input type="email" x-model="registerForm.email" required
                               class="w-full px-4 py-2 bg-gray-700 rounded border border-gray-600 focus:border-green-400 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Password (min. 8 characters)</label>
                        <input type="password" x-model="registerForm.password" required minlength="8"
                               class="w-full px-4 py-2 bg-gray-700 rounded border border-gray-600 focus:border-green-400 focus:outline-none">
                    </div>
                    <button type="submit"
                            class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded transition">
                        Create Account
                    </button>
                </form>

                <!-- Error Message -->
                <div x-show="authError" class="mt-4 p-3 bg-red-500 bg-opacity-20 border border-red-500 rounded text-sm"
                     x-text="authError"></div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div x-show="isAuthenticated" class="container mx-auto px-4 py-8">
            <!-- Header -->
            <header class="mb-8 flex justify-between items-start">
                <div>
                    <h1 class="text-4xl font-bold text-green-400 flex items-center gap-2">
                        <span>PayPerPlay</span>
                        <span class="text-sm text-gray-400 font-normal">v2.0</span>
                    </h1>
                    <p class="text-gray-400">Minecraft Hosting - Pay only when you play ‚ö°</p>
                    <p class="text-xs text-gray-500 mt-1">
                        Auto-Shutdown ‚Ä¢ Real-time Monitoring ‚Ä¢ Backups ‚Ä¢ Plugins
                    </p>
                </div>
                <div class="text-right">
                    <!-- Connection Status Indicator -->
                    <div class="mb-2 flex items-center justify-end gap-2">
                        <div :class="{
                            'bg-green-500': connectionStatus === 'connected',
                            'bg-yellow-500': connectionStatus === 'reconnecting',
                            'bg-red-500': connectionStatus === 'disconnected'
                        }" class="w-2 h-2 rounded-full animate-pulse"></div>
                        <span class="text-xs text-gray-400" x-text="{
                            'connected': 'Connected',
                            'reconnecting': 'Reconnecting...',
                            'disconnected': 'Connection Lost'
                        }[connectionStatus]"></span>
                    </div>

                    <div class="text-sm text-gray-400">
                        <span x-text="user?.username || user?.email"></span>
                    </div>
                    <div class="text-2xl font-bold text-green-400">
                        ‚Ç¨<span x-text="user?.balance?.toFixed(2) || '0.00'"></span>
                    </div>
                    <button @click="logout"
                            class="mt-2 text-sm text-red-400 hover:text-red-300 transition">
                        Logout
                    </button>
                    <button @click="adminMode = !adminMode; loadServers()"
                            :class="adminMode ? 'bg-red-600' : 'bg-gray-700'"
                            class="mt-2 px-3 py-1 text-xs rounded hover:opacity-80 transition block">
                        <span x-text="adminMode ? '‚ö†Ô∏è Admin ON' : 'üîß Admin OFF'"></span>
                    </button>
                </div>
            </header>

            <!-- Admin Tools (only shown when admin mode is on) -->
            <div x-show="adminMode" class="bg-red-900/20 border border-red-500/30 rounded-lg p-4 mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-bold text-red-400">‚ö†Ô∏è Admin Mode Active</h3>
                        <p class="text-sm text-gray-400">Showing ALL servers from ALL users</p>
                    </div>
                    <button @click="cleanOrphanedServers()"
                            class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded transition">
                        üßπ Clean Orphaned Servers
                    </button>
                </div>
            </div>

            <!-- Create Server Form -->
            <div class="bg-gray-800 rounded-lg p-6 mb-8">
                <h2 class="text-2xl font-bold mb-4">Create New Server</h2>
                <form @submit.prevent="createServer" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Server Name</label>
                        <input type="text" x-model="newServer.name" required
                               class="w-full px-4 py-2 bg-gray-700 rounded border border-gray-600 focus:border-green-400 focus:outline-none">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Server Type</label>
                            <select x-model="newServer.server_type" required
                                    class="w-full px-4 py-2 bg-gray-700 rounded border border-gray-600 focus:border-green-400 focus:outline-none">
                                <option value="paper">Paper (Recommended - Plugins)</option>
                                <option value="spigot">Spigot (Plugins)</option>
                                <option value="forge">Forge (Mods)</option>
                                <option value="fabric">Fabric (Mods, Performance)</option>
                                <option value="vanilla">Vanilla (Pure MC)</option>
                                <option value="purpur">Purpur (Experimental)</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Minecraft Version</label>
                            <input type="text" x-model="newServer.minecraft_version" placeholder="1.20.4" required
                                   class="w-full px-4 py-2 bg-gray-700 rounded border border-gray-600 focus:border-green-400 focus:outline-none">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-2">RAM</label>
                        <select x-model.number="newServer.ram_mb" required
                                class="w-full px-4 py-2 bg-gray-700 rounded border border-gray-600 focus:border-green-400 focus:outline-none">
                            <option value="2048">2 GB - ‚Ç¨0.10/hour (1-5 players)</option>
                            <option value="4096">4 GB - ‚Ç¨0.20/hour (6-15 players)</option>
                            <option value="8192">8 GB - ‚Ç¨0.40/hour (16-30 players)</option>
                            <option value="16384">16 GB - ‚Ç¨0.80/hour (31+ players)</option>
                        </select>
                    </div>

                    <button type="submit"
                            class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded transition">
                        Create Server
                    </button>
                </form>
            </div>

            <!-- Servers List -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h2 class="text-2xl font-bold mb-4">Your Servers</h2>

                <div x-show="loading" class="text-center py-8">
                    <p class="text-gray-400">Loading servers...</p>
                </div>

                <div x-show="!loading && servers.length === 0" class="text-center py-8">
                    <p class="text-gray-400">No servers yet. Create one above!</p>
                </div>

                <div x-show="!loading && servers.length > 0" class="space-y-4">
                    <template x-for="server in servers" :key="server.ID">
                        <div class="bg-gray-700 rounded-lg p-5">
                            <!-- Server Header -->
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex gap-3 flex-1">
                                    <!-- Server Icon -->
                                    <img :src="`/api/servers/${server.ID}/icon`"
                                         :alt="`${server.Name} icon`"
                                         @error="$el.style.display='none'"
                                         class="w-16 h-16 rounded object-cover flex-shrink-0 border-2 border-gray-600">

                                    <div class="flex-1">
                                        <h3 class="text-xl font-bold flex items-center gap-2">
                                            <span x-text="server.Name"></span>
                                            <span :class="{
                                                'bg-green-500': server.Status === 'running',
                                                'bg-gray-500': server.Status === 'stopped',
                                                'bg-yellow-500': server.Status === 'starting' || server.Status === 'stopping',
                                                'bg-red-500': server.Status === 'error'
                                            }" class="px-3 py-1 rounded-full text-xs font-semibold uppercase">
                                                <span x-text="server.Status"></span>
                                            </span>
                                        </h3>
                                    <div class="text-sm text-gray-300 mt-1 flex flex-wrap gap-x-3 gap-y-1">
                                        <span class="flex items-center gap-1">
                                            <span class="text-green-400">‚óè</span>
                                            <span x-text="server.ServerType"></span>
                                        </span>
                                        <span>MC <span x-text="server.MinecraftVersion"></span></span>
                                        <span><span x-text="(server.RAMMb / 1024).toFixed(0)"></span> GB RAM</span>
                                        <span>Port: <span x-text="server.Port"></span></span>
                                        <span x-show="adminMode" class="text-yellow-400">Owner: <span x-text="server.OwnerID"></span></span>
                                    </div>

                                    <!-- Real-time Status (if running) -->
                                    <div x-show="server.Status === 'running' && serverStatuses[server.ID]"
                                         class="mt-2 text-xs text-gray-400 flex gap-4">
                                        <span class="flex items-center gap-1">
                                            <span class="text-blue-400">üë•</span>
                                            <span x-text="serverStatuses[server.ID]?.player_count || 0"></span> players
                                        </span>
                                        <span x-show="serverStatuses[server.ID]?.idle_seconds > 0">
                                            Idle: <span x-text="formatSeconds(serverStatuses[server.ID]?.idle_seconds)"></span>
                                            / <span x-text="formatSeconds(serverStatuses[server.ID]?.timeout_seconds)"></span>
                                        </span>
                                    </div>
                                    </div>
                                </div>

                                <div class="flex gap-2 flex-wrap">
                                    <button @click="startServer(server.ID)"
                                            x-show="server.Status === 'stopped'"
                                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded transition text-sm">
                                        Start
                                    </button>
                                    <button @click="stopServer(server.ID)"
                                            x-show="server.Status === 'running'"
                                            class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded transition text-sm">
                                        Stop
                                    </button>
                                    <button @click="restartServer(server.ID)"
                                            x-show="server.Status === 'running' || server.Status === 'error'"
                                            :class="server.Status === 'error' ? 'bg-orange-500 hover:bg-orange-600' : 'bg-purple-500 hover:bg-purple-600'"
                                            class="text-white px-4 py-2 rounded transition text-sm">
                                        Restart
                                    </button>
                                    <button @click="viewDetails(server)"
                                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded transition text-sm">
                                        Details
                                    </button>
                                    <button @click="deleteServer(server.ID)"
                                            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded transition text-sm">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Server Details Modal -->
            <div x-show="detailsModal.show"
                 class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
                 x-cloak>
                <div class="bg-gray-800 rounded-lg p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <h3 class="text-2xl font-bold mb-4" x-text="detailsModal.server?.Name"></h3>

                    <!-- Tabs -->
                    <div class="flex gap-2 mb-4 border-b border-gray-700">
                        <button @click="detailsModal.tab = 'usage'"
                                :class="detailsModal.tab === 'usage' ? 'border-green-400 text-green-400' : 'border-transparent'"
                                class="px-4 py-2 border-b-2 transition">
                            Usage
                        </button>
                        <button @click="detailsModal.tab = 'backups'"
                                :class="detailsModal.tab === 'backups' ? 'border-green-400 text-green-400' : 'border-transparent'"
                                class="px-4 py-2 border-b-2 transition">
                            Backups
                        </button>
                        <button @click="detailsModal.tab = 'plugins'"
                                :class="detailsModal.tab === 'plugins' ? 'border-green-400 text-green-400' : 'border-transparent'"
                                class="px-4 py-2 border-b-2 transition"
                                x-show="['paper', 'spigot', 'purpur'].includes(detailsModal.server?.ServerType)">
                            Plugins
                        </button>
                        <button @click="detailsModal.tab = 'logs'"
                                :class="detailsModal.tab === 'logs' ? 'border-green-400 text-green-400' : 'border-transparent'"
                                class="px-4 py-2 border-b-2 transition">
                            Logs
                        </button>
                        <button @click="detailsModal.tab = 'console'; connectConsole()"
                                :class="detailsModal.tab === 'console' ? 'border-green-400 text-green-400' : 'border-transparent'"
                                class="px-4 py-2 border-b-2 transition"
                                x-show="detailsModal.server?.Status === 'running'">
                            Console
                        </button>
                        <button @click="detailsModal.tab = 'config'"
                                :class="detailsModal.tab === 'config' ? 'border-green-400 text-green-400' : 'border-transparent'"
                                class="px-4 py-2 border-b-2 transition">
                            Configuration
                        </button>
                        <button @click="detailsModal.tab = 'files'"
                                :class="detailsModal.tab === 'files' ? 'border-green-400 text-green-400' : 'border-transparent'"
                                class="px-4 py-2 border-b-2 transition">
                            Files
                        </button>
                        <button @click="detailsModal.tab = 'appearance'"
                                :class="detailsModal.tab === 'appearance' ? 'border-green-400 text-green-400' : 'border-transparent'"
                                class="px-4 py-2 border-b-2 transition">
                            Appearance
                        </button>
                        <button @click="detailsModal.tab = 'players'"
                                :class="detailsModal.tab === 'players' ? 'border-green-400 text-green-400' : 'border-transparent'"
                                class="px-4 py-2 border-b-2 transition">
                            Players
                        </button>
                    </div>

                    <!-- Tab Content -->
                    <div class="min-h-[400px]">
                        <!-- Usage Tab -->
                        <div x-show="detailsModal.tab === 'usage'" class="space-y-2">
                            <template x-for="log in detailsModal.usageLogs" :key="log.ID">
                                <div class="bg-gray-700 p-3 rounded">
                                    <div class="flex justify-between">
                                        <span x-text="new Date(log.StartedAt).toLocaleString()"></span>
                                        <span x-text="'‚Ç¨' + (log.CostEUR || 0).toFixed(4)" class="font-bold text-green-400"></span>
                                    </div>
                                    <div class="text-sm text-gray-400 mt-1">
                                        <span x-show="log.DurationSeconds">
                                            Duration: <span x-text="formatDuration(log.DurationSeconds)"></span>
                                        </span>
                                        <span x-show="log.PlayerCountPeak > 0" class="ml-3">
                                            Peak: <span x-text="log.PlayerCountPeak"></span> players
                                        </span>
                                        <span x-show="log.ShutdownReason" class="ml-3">
                                            Reason: <span x-text="log.ShutdownReason"></span>
                                        </span>
                                    </div>
                                </div>
                            </template>
                            <div x-show="detailsModal.usageLogs.length === 0" class="text-center py-8 text-gray-400">
                                No usage logs yet
                            </div>
                        </div>

                        <!-- Backups Tab -->
                        <div x-show="detailsModal.tab === 'backups'" class="space-y-3">
                            <button @click="createBackup(detailsModal.server?.ID)"
                                    class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded transition">
                                Create Backup Now
                            </button>
                            <template x-for="backup in detailsModal.backups" :key="backup.filename">
                                <div class="bg-gray-700 p-3 rounded flex justify-between items-center">
                                    <div>
                                        <div x-text="backup.filename"></div>
                                        <div class="text-xs text-gray-400">
                                            <span x-text="(backup.size_bytes / 1024 / 1024).toFixed(2) + ' MB'"></span> ‚Ä¢
                                            <span x-text="new Date(backup.created_at).toLocaleString()"></span>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button @click="restoreBackup(detailsModal.server?.ID, backup.path)"
                                                class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">
                                            Restore
                                        </button>
                                        <button @click="deleteBackup(detailsModal.server?.ID, backup.filename)"
                                                class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            </template>
                            <div x-show="detailsModal.backups.length === 0" class="text-center py-8 text-gray-400">
                                No backups yet. Create one above!
                            </div>
                        </div>

                        <!-- Plugins Tab -->
                        <div x-show="detailsModal.tab === 'plugins'" class="space-y-3">
                            <div class="flex gap-2">
                                <input type="text" x-model="pluginSearch" placeholder="Search plugins..."
                                       class="flex-1 px-4 py-2 bg-gray-700 rounded border border-gray-600">
                                <button @click="searchPlugins()"
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                                    Search
                                </button>
                            </div>

                            <div x-show="availablePlugins.length > 0" class="space-y-2">
                                <h4 class="font-bold">Available Plugins</h4>
                                <template x-for="plugin in availablePlugins" :key="plugin.name">
                                    <div class="bg-gray-700 p-3 rounded flex justify-between items-center">
                                        <div>
                                            <div class="font-semibold" x-text="plugin.name"></div>
                                            <div class="text-xs text-gray-400" x-text="plugin.description"></div>
                                        </div>
                                        <button @click="installPlugin(detailsModal.server?.ID, plugin)"
                                                class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">
                                            Install
                                        </button>
                                    </div>
                                </template>
                            </div>

                            <div class="border-t border-gray-600 pt-3">
                                <h4 class="font-bold mb-2">Installed Plugins</h4>
                                <template x-for="plugin in detailsModal.plugins" :key="plugin.filename">
                                    <div class="bg-gray-700 p-2 rounded flex justify-between items-center">
                                        <span x-text="plugin.filename"></span>
                                        <button @click="removePlugin(detailsModal.server?.ID, plugin.filename)"
                                                class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs">
                                            Remove
                                        </button>
                                    </div>
                                </template>
                                <div x-show="detailsModal.plugins.length === 0" class="text-center py-4 text-gray-400 text-sm">
                                    No plugins installed
                                </div>
                            </div>
                        </div>

                        <!-- Logs Tab -->
                        <div x-show="detailsModal.tab === 'logs'">
                            <pre class="bg-gray-900 p-4 rounded text-xs overflow-auto max-h-96 text-green-400 font-mono"
                                 x-text="detailsModal.logs"></pre>
                        </div>

                        <!-- Console Tab -->
                        <div x-show="detailsModal.tab === 'console'" class="space-y-3">
                            <!-- Console output -->
                            <div class="bg-gray-900 rounded p-4 h-96 overflow-y-auto font-mono text-xs"
                                 x-ref="consoleOutput">
                                <template x-for="(line, idx) in detailsModal.consoleLogs" :key="idx">
                                    <div :class="{
                                        'text-green-400': line.type === 'log',
                                        'text-blue-400': line.type === 'command',
                                        'text-yellow-400': line.type === 'response',
                                        'text-red-400': line.type === 'error'
                                    }">
                                        <span x-show="line.type === 'command'">&gt; </span>
                                        <span x-text="line.content"></span>
                                    </div>
                                </template>
                                <div x-show="detailsModal.consoleLogs.length === 0" class="text-gray-500">
                                    Connecting to console...
                                </div>
                            </div>

                            <!-- Command input -->
                            <div class="flex gap-2">
                                <input type="text"
                                       x-model="consoleCommand"
                                       @keydown.enter="sendCommand()"
                                       @keydown.up="navigateHistory(-1)"
                                       @keydown.down="navigateHistory(1)"
                                       placeholder="Type command (e.g., 'list', 'say Hello')"
                                       class="flex-1 px-4 py-2 bg-gray-700 rounded border border-gray-600 font-mono text-sm"
                                       :disabled="!detailsModal.consoleConnected">
                                <button @click="sendCommand()"
                                        :disabled="!detailsModal.consoleConnected || !consoleCommand.trim()"
                                        class="bg-green-500 hover:bg-green-600 disabled:bg-gray-600 text-white px-6 py-2 rounded transition">
                                    Send
                                </button>
                            </div>

                            <!-- Connection status -->
                            <div class="text-xs text-gray-400 flex items-center gap-2">
                                <div :class="detailsModal.consoleConnected ? 'bg-green-500' : 'bg-red-500'"
                                     class="w-2 h-2 rounded-full"></div>
                                <span x-text="detailsModal.consoleConnected ? 'Connected' : 'Disconnected'"></span>
                            </div>
                        </div>

                        <!-- Configuration Tab -->
                        <div x-show="detailsModal.tab === 'config'" class="space-y-4">
                            <div class="bg-gray-700 p-4 rounded">
                                <h3 class="text-lg font-semibold mb-4">Server Configuration</h3>

                                <!-- RAM Configuration -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2">RAM Allocation</label>
                                    <select x-model="configForm.ram_mb"
                                            class="w-full px-4 py-2 bg-gray-600 rounded border border-gray-500">
                                        <option value="2048">2 GB</option>
                                        <option value="4096">4 GB</option>
                                        <option value="8192">8 GB</option>
                                        <option value="16384">16 GB</option>
                                    </select>
                                    <p class="text-xs text-gray-400 mt-1">Current: <span x-text="detailsModal.server?.RAMMb / 1024"></span> GB</p>
                                </div>

                                <!-- Minecraft Version -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2">Minecraft Version</label>
                                    <input type="text"
                                           x-model="configForm.minecraft_version"
                                           placeholder="e.g., 1.21.1"
                                           class="w-full px-4 py-2 bg-gray-600 rounded border border-gray-500">
                                    <p class="text-xs text-gray-400 mt-1">Current: <span x-text="detailsModal.server?.MinecraftVersion"></span></p>
                                </div>

                                <!-- Server Type -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2">Server Type</label>
                                    <select x-model="configForm.server_type"
                                            class="w-full px-4 py-2 bg-gray-600 rounded border border-gray-500">
                                        <option value="paper">Paper (Recommended)</option>
                                        <option value="spigot">Spigot</option>
                                        <option value="bukkit">Bukkit</option>
                                    </select>
                                    <p class="text-xs text-gray-400 mt-1">Current: <span x-text="detailsModal.server?.ServerType"></span></p>
                                    <p class="text-xs text-yellow-400 mt-1">‚ö†Ô∏è Paper/Spigot/Bukkit configs are preserved but may be inactive</p>
                                </div>

                                <!-- Max Players -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2">Max Players</label>
                                    <input type="number"
                                           x-model="configForm.max_players"
                                           min="1"
                                           max="100"
                                           class="w-full px-4 py-2 bg-gray-600 rounded border border-gray-500">
                                    <p class="text-xs text-gray-400 mt-1">Current: <span x-text="detailsModal.server?.MaxPlayers"></span></p>
                                </div>

                                <!-- Gameplay Settings Section -->
                                <div class="border-t border-gray-600 my-4 pt-4">
                                    <h4 class="text-lg font-semibold mb-3">üéÆ Gameplay Settings</h4>

                                    <!-- Gamemode -->
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium mb-2">Gamemode</label>
                                        <select x-model="configForm.gamemode"
                                                class="w-full px-4 py-2 bg-gray-600 rounded border border-gray-500">
                                            <template x-for="mode in getAvailableGamemodes()" :key="mode.value">
                                                <option :value="mode.value"
                                                        :disabled="!mode.enabled"
                                                        :class="!mode.enabled ? 'text-gray-500' : ''"
                                                        x-text="mode.label + (!mode.enabled ? ' (Not available in this version)' : '')">
                                                </option>
                                            </template>
                                        </select>
                                        <p class="text-xs text-gray-400 mt-1">Current: <span x-text="detailsModal.server?.Gamemode || 'survival'"></span></p>
                                        <p x-show="!isGamemodeSupported(configForm.gamemode)" class="text-xs text-red-400 mt-1">
                                            ‚ö†Ô∏è <span x-text="getGamemodeWarning(configForm.gamemode)"></span>
                                        </p>
                                    </div>

                                    <!-- Difficulty -->
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium mb-2">Difficulty</label>
                                        <select x-model="configForm.difficulty"
                                                class="w-full px-4 py-2 bg-gray-600 rounded border border-gray-500">
                                            <option value="peaceful">Peaceful</option>
                                            <option value="easy">Easy</option>
                                            <option value="normal">Normal</option>
                                            <option value="hard">Hard</option>
                                        </select>
                                        <p class="text-xs text-gray-400 mt-1">Current: <span x-text="detailsModal.server?.Difficulty || 'normal'"></span></p>
                                    </div>

                                    <!-- PVP -->
                                    <div class="mb-4">
                                        <label class="flex items-center cursor-pointer">
                                            <input type="checkbox"
                                                   x-model="configForm.pvp"
                                                   class="mr-2 w-5 h-5">
                                            <span class="text-sm font-medium">Enable PvP</span>
                                        </label>
                                        <p class="text-xs text-gray-400 mt-1">Current: <span x-text="detailsModal.server?.PVP ? 'Enabled' : 'Disabled'"></span></p>
                                    </div>

                                    <!-- Command Blocks -->
                                    <div class="mb-4">
                                        <label class="flex items-center cursor-pointer"
                                               :class="!areCommandBlocksSupported() ? 'opacity-50 cursor-not-allowed' : ''">
                                            <input type="checkbox"
                                                   x-model="configForm.enable_command_block"
                                                   :disabled="!areCommandBlocksSupported()"
                                                   class="mr-2 w-5 h-5">
                                            <span class="text-sm font-medium">Enable Command Blocks</span>
                                        </label>
                                        <p class="text-xs text-gray-400 mt-1">Current: <span x-text="detailsModal.server?.EnableCommandBlock ? 'Enabled' : 'Disabled'"></span></p>
                                        <p x-show="!areCommandBlocksSupported()" class="text-xs text-red-400 mt-1">
                                            ‚ö†Ô∏è Command blocks require Minecraft 1.4.2+. Current: <span x-text="configForm.minecraft_version"></span>
                                        </p>
                                    </div>

                                    <!-- Level Seed -->
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium mb-2">World Seed (optional)</label>
                                        <input type="text"
                                               x-model="configForm.level_seed"
                                               placeholder="Leave empty for random"
                                               class="w-full px-4 py-2 bg-gray-600 rounded border border-gray-500">
                                        <p class="text-xs text-gray-400 mt-1">Current: <span x-text="detailsModal.server?.LevelSeed || 'Random'"></span></p>
                                        <p class="text-xs text-yellow-400 mt-1">‚ö†Ô∏è Only affects new worlds</p>
                                    </div>
                                </div>

                                <!-- Phase 2: Performance Settings -->
                                <div class="border-t border-gray-600 my-4 pt-4">
                                    <h4 class="text-lg font-semibold mb-3">‚ö° Performance Settings</h4>

                                    <!-- View Distance -->
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium mb-2">View Distance</label>
                                        <input type="number"
                                               x-model.number="configForm.view_distance"
                                               min="2" max="32" step="1"
                                               class="w-full px-4 py-2 bg-gray-600 rounded border border-gray-500">
                                        <p class="text-xs text-gray-400 mt-1">Render distance in chunks (2-32). Current: <span x-text="detailsModal.server?.ViewDistance || 10"></span></p>
                                        <p class="text-xs text-yellow-400 mt-1">‚ö†Ô∏è Higher values require more RAM and CPU</p>
                                    </div>

                                    <!-- Simulation Distance -->
                                    <div class="mb-4"
                                         :class="!isSimulationDistanceSupported() ? 'opacity-50' : ''">
                                        <label class="block text-sm font-medium mb-2">Simulation Distance</label>
                                        <input type="number"
                                               x-model.number="configForm.simulation_distance"
                                               :disabled="!isSimulationDistanceSupported()"
                                               min="3" max="32" step="1"
                                               class="w-full px-4 py-2 bg-gray-600 rounded border border-gray-500">
                                        <p class="text-xs text-gray-400 mt-1">Simulation distance in chunks (3-32). Current: <span x-text="detailsModal.server?.SimulationDistance || 10"></span></p>
                                        <p x-show="!isSimulationDistanceSupported()" class="text-xs text-red-400 mt-1">
                                            ‚ö†Ô∏è Simulation distance requires Minecraft 1.18+. Current: <span x-text="configForm.minecraft_version"></span>
                                        </p>
                                    </div>
                                </div>

                                <!-- Phase 2: World Generation Settings -->
                                <div class="border-t border-gray-600 my-4 pt-4">
                                    <h4 class="text-lg font-semibold mb-3">üåç World Generation Settings</h4>

                                    <!-- World Type -->
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium mb-2">World Type</label>
                                        <select x-model="configForm.world_type"
                                                class="w-full px-4 py-2 bg-gray-600 rounded border border-gray-500">
                                            <template x-for="type in getAvailableWorldTypes()" :key="type.value">
                                                <option :value="type.value"
                                                        :disabled="!type.enabled"
                                                        :class="!type.enabled ? 'text-gray-500' : ''"
                                                        x-text="type.label + (!type.enabled ? ' (Not available in this version)' : '')">
                                                </option>
                                            </template>
                                        </select>
                                        <p class="text-xs text-gray-400 mt-1">Current: <span x-text="detailsModal.server?.WorldType || 'default'"></span></p>
                                        <p class="text-xs text-yellow-400 mt-1">‚ö†Ô∏è Only affects new worlds</p>
                                    </div>

                                    <!-- Dimensions -->
                                    <div class="mb-4">
                                        <label class="flex items-center cursor-pointer mb-2">
                                            <input type="checkbox"
                                                   x-model="configForm.allow_nether"
                                                   class="mr-2 w-5 h-5">
                                            <span class="text-sm font-medium">Enable Nether</span>
                                        </label>
                                        <label class="flex items-center cursor-pointer">
                                            <input type="checkbox"
                                                   x-model="configForm.allow_end"
                                                   class="mr-2 w-5 h-5">
                                            <span class="text-sm font-medium">Enable End</span>
                                        </label>
                                        <p class="text-xs text-gray-400 mt-2">
                                            Current: Nether <span x-text="detailsModal.server?.AllowNether ? 'Enabled' : 'Disabled'"></span>,
                                            End <span x-text="detailsModal.server?.AllowEnd ? 'Enabled' : 'Disabled'"></span>
                                        </p>
                                    </div>

                                    <!-- Structures -->
                                    <div class="mb-4">
                                        <label class="flex items-center cursor-pointer">
                                            <input type="checkbox"
                                                   x-model="configForm.generate_structures"
                                                   class="mr-2 w-5 h-5">
                                            <span class="text-sm font-medium">Generate Structures</span>
                                        </label>
                                        <p class="text-xs text-gray-400 mt-1">Villages, temples, strongholds, etc. Current: <span x-text="detailsModal.server?.GenerateStructures ? 'Enabled' : 'Disabled'"></span></p>
                                        <p class="text-xs text-yellow-400 mt-1">‚ö†Ô∏è Only affects new worlds</p>
                                    </div>

                                    <!-- Bonus Chest -->
                                    <div class="mb-4">
                                        <label class="flex items-center cursor-pointer">
                                            <input type="checkbox"
                                                   x-model="configForm.bonus_chest"
                                                   class="mr-2 w-5 h-5">
                                            <span class="text-sm font-medium">Bonus Chest</span>
                                        </label>
                                        <p class="text-xs text-gray-400 mt-1">Spawn with starting items. Current: <span x-text="detailsModal.server?.BonusChest ? 'Enabled' : 'Disabled'"></span></p>
                                        <p class="text-xs text-yellow-400 mt-1">‚ö†Ô∏è Only affects new worlds</p>
                                    </div>

                                    <!-- Max World Size -->
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium mb-2">Max World Size (blocks)</label>
                                        <input type="number"
                                               x-model.number="configForm.max_world_size"
                                               min="1" max="29999984" step="1000"
                                               class="w-full px-4 py-2 bg-gray-600 rounded border border-gray-500">
                                        <p class="text-xs text-gray-400 mt-1">World border size. Current: <span x-text="detailsModal.server?.MaxWorldSize || 29999984"></span></p>
                                    </div>
                                </div>

                                <!-- Phase 2: Spawn Settings -->
                                <div class="border-t border-gray-600 my-4 pt-4">
                                    <h4 class="text-lg font-semibold mb-3">üê∑ Spawn Settings</h4>

                                    <!-- Spawn Protection -->
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium mb-2">Spawn Protection Radius</label>
                                        <input type="number"
                                               x-model.number="configForm.spawn_protection"
                                               min="0" max="128" step="1"
                                               class="w-full px-4 py-2 bg-gray-600 rounded border border-gray-500">
                                        <p class="text-xs text-gray-400 mt-1">Radius around spawn where only ops can build (0 to disable). Current: <span x-text="detailsModal.server?.SpawnProtection || 16"></span></p>
                                    </div>

                                    <!-- Mob Spawning -->
                                    <div class="mb-4">
                                        <label class="flex items-center cursor-pointer mb-2">
                                            <input type="checkbox"
                                                   x-model="configForm.spawn_animals"
                                                   class="mr-2 w-5 h-5">
                                            <span class="text-sm font-medium">Spawn Animals</span>
                                        </label>
                                        <label class="flex items-center cursor-pointer mb-2">
                                            <input type="checkbox"
                                                   x-model="configForm.spawn_monsters"
                                                   class="mr-2 w-5 h-5">
                                            <span class="text-sm font-medium">Spawn Monsters</span>
                                        </label>
                                        <label class="flex items-center cursor-pointer">
                                            <input type="checkbox"
                                                   x-model="configForm.spawn_npcs"
                                                   class="mr-2 w-5 h-5">
                                            <span class="text-sm font-medium">Spawn NPCs (Villagers)</span>
                                        </label>
                                        <p class="text-xs text-gray-400 mt-2">
                                            Current: Animals <span x-text="detailsModal.server?.SpawnAnimals ? 'Yes' : 'No'"></span>,
                                            Monsters <span x-text="detailsModal.server?.SpawnMonsters ? 'Yes' : 'No'"></span>,
                                            NPCs <span x-text="detailsModal.server?.SpawnNPCs ? 'Yes' : 'No'"></span>
                                        </p>
                                    </div>
                                </div>

                                <!-- Phase 2: Advanced Network Settings (Collapsible) -->
                                <div class="border-t border-gray-600 my-4 pt-4" x-data="{ advancedExpanded: false }">
                                    <button @click="advancedExpanded = !advancedExpanded"
                                            class="w-full flex items-center justify-between text-lg font-semibold mb-3 hover:text-blue-400 transition">
                                        <span>üîß Advanced Network & Performance</span>
                                        <svg class="w-5 h-5 transition-transform" :class="advancedExpanded ? 'rotate-180' : ''"
                                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>

                                    <div x-show="advancedExpanded" x-collapse>
                                        <!-- Max Tick Time -->
                                        <div class="mb-4">
                                            <label class="block text-sm font-medium mb-2">Max Tick Time (ms)</label>
                                            <input type="number"
                                                   x-model.number="configForm.max_tick_time"
                                                   min="-1" step="1000"
                                                   class="w-full px-4 py-2 bg-gray-600 rounded border border-gray-500">
                                            <p class="text-xs text-gray-400 mt-1">Watchdog timeout in milliseconds (-1 to disable). Current: <span x-text="detailsModal.server?.MaxTickTime || 60000"></span></p>
                                            <p class="text-xs text-yellow-400 mt-1">‚ö†Ô∏è Only change if you know what you're doing</p>
                                        </div>

                                        <!-- Network Compression Threshold -->
                                        <div class="mb-4">
                                            <label class="block text-sm font-medium mb-2">Network Compression Threshold (bytes)</label>
                                            <input type="number"
                                                   x-model.number="configForm.network_compression_threshold"
                                                   min="-1" step="64"
                                                   class="w-full px-4 py-2 bg-gray-600 rounded border border-gray-500">
                                            <p class="text-xs text-gray-400 mt-1">Packet compression threshold (-1 to disable). Current: <span x-text="detailsModal.server?.NetworkCompressionThreshold || 256"></span></p>
                                            <p class="text-xs text-yellow-400 mt-1">‚ö†Ô∏è Only change if you know what you're doing</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Phase 4: Server Description (MOTD) -->
                                <div class="border-t border-gray-600 my-4 pt-4">
                                    <h4 class="text-lg font-semibold mb-3">üìù Server Description (MOTD)</h4>

                                    <div class="mb-4">
                                        <label class="block text-sm font-medium mb-2">Message of the Day</label>
                                        <textarea x-model="configForm.motd"
                                                  rows="3"
                                                  maxlength="512"
                                                  placeholder="A Minecraft Server"
                                                  class="w-full px-4 py-2 bg-gray-600 rounded border border-gray-500 font-mono text-sm"></textarea>
                                        <p class="text-xs text-gray-400 mt-1">
                                            Current: <span x-text="detailsModal.server?.MOTD || 'A Minecraft Server'"></span>
                                        </p>
                                        <p class="text-xs text-gray-400 mt-1">
                                            <span x-text="(configForm.motd || '').length"></span>/512 characters
                                        </p>
                                        <p class="text-xs text-blue-400 mt-1">
                                            üí° Tip: Use Minecraft color codes like ¬ßa (green), ¬ßc (red), ¬ßl (bold)
                                        </p>
                                        <p class="text-xs text-yellow-400 mt-1">
                                            ‚ö†Ô∏è Requires server restart to take effect
                                        </p>
                                    </div>
                                </div>

                                <!-- Apply Button -->
                                <button @click="applyConfigChanges()"
                                        :disabled="configApplying"
                                        class="w-full bg-green-500 hover:bg-green-600 disabled:bg-gray-600 text-white py-2 rounded transition">
                                    <span x-show="!configApplying">Apply Configuration</span>
                                    <span x-show="configApplying">Applying...</span>
                                </button>

                                <!-- Warning -->
                                <p class="text-xs text-yellow-400 mt-2">
                                    ‚ö†Ô∏è Some changes may require server restart
                                </p>
                            </div>

                            <!-- Configuration History -->
                            <div class="bg-gray-700 p-4 rounded">
                                <h3 class="text-lg font-semibold mb-3">Change History</h3>
                                <div class="space-y-2 max-h-64 overflow-y-auto">
                                    <template x-for="change in configHistory" :key="change.ID">
                                        <div class="bg-gray-800 p-3 rounded text-sm">
                                            <div class="flex justify-between items-start">
                                                <span class="font-medium" x-text="change.ChangeType"></span>
                                                <span :class="{
                                                    'text-green-400': change.Status === 'completed',
                                                    'text-yellow-400': change.Status === 'pending' || change.Status === 'applying',
                                                    'text-red-400': change.Status === 'failed'
                                                }" x-text="change.Status"></span>
                                            </div>
                                            <div class="text-xs text-gray-400 mt-1">
                                                <span x-text="change.OldValue"></span>
                                                ‚Üí
                                                <span x-text="change.NewValue"></span>
                                            </div>
                                            <div class="text-xs text-gray-500 mt-1" x-show="change.AppliedAt">
                                                <span x-text="new Date(change.AppliedAt).toLocaleString()"></span>
                                            </div>
                                        </div>
                                    </template>
                                    <div x-show="configHistory.length === 0" class="text-center py-4 text-gray-400">
                                        No configuration changes yet
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Files Tab -->
                        <div x-show="detailsModal.tab === 'files'" class="space-y-4">
                            <div x-data="{ activeFileType: 'resource_pack' }">
                                <!-- File Type Tabs -->
                                <div class="flex gap-2 mb-4 border-b border-gray-700">
                                    <button @click="activeFileType = 'resource_pack'"
                                            :class="activeFileType === 'resource_pack' ? 'border-blue-400 text-blue-400' : 'border-transparent'"
                                            class="px-4 py-2 border-b-2 transition">
                                        üì¶ Resource Packs
                                    </button>
                                    <button @click="activeFileType = 'data_pack'"
                                            :class="activeFileType === 'data_pack' ? 'border-purple-400 text-purple-400' : 'border-transparent'"
                                            class="px-4 py-2 border-b-2 transition">
                                        üìä Data Packs
                                    </button>
                                    <button @click="activeFileType = 'server_icon'"
                                            :class="activeFileType === 'server_icon' ? 'border-green-400 text-green-400' : 'border-transparent'"
                                            class="px-4 py-2 border-b-2 transition">
                                        üñºÔ∏è Server Icon
                                    </button>
                                    <button @click="activeFileType = 'world_gen'"
                                            :class="activeFileType === 'world_gen' ? 'border-yellow-400 text-yellow-400' : 'border-transparent'"
                                            class="px-4 py-2 border-b-2 transition">
                                        üåç World Gen
                                    </button>
                                </div>

                                <!-- Resource Packs -->
                                <div x-show="activeFileType === 'resource_pack'"
                                     x-data="fileUploader(detailsModal.server?.ID, 'resource_pack')"
                                     x-init="init()">
                                    <div x-html="renderUploadZone.call($data)"></div>
                                    <div x-html="renderFileList.call($data)" class="mt-4"></div>
                                </div>

                                <!-- Data Packs -->
                                <div x-show="activeFileType === 'data_pack'"
                                     x-data="fileUploader(detailsModal.server?.ID, 'data_pack')"
                                     x-init="init()">
                                    <div x-html="renderUploadZone.call($data)"></div>
                                    <div x-html="renderFileList.call($data)" class="mt-4"></div>
                                </div>

                                <!-- Server Icon -->
                                <div x-show="activeFileType === 'server_icon'"
                                     x-data="fileUploader(detailsModal.server?.ID, 'server_icon')"
                                     x-init="init()">
                                    <div x-html="renderUploadZone.call($data)"></div>
                                    <div x-html="renderFileList.call($data)" class="mt-4"></div>
                                </div>

                                <!-- World Gen -->
                                <div x-show="activeFileType === 'world_gen'"
                                     x-data="fileUploader(detailsModal.server?.ID, 'world_gen')"
                                     x-init="init()">
                                    <div x-html="renderUploadZone.call($data)"></div>
                                    <div x-html="renderFileList.call($data)" class="mt-4"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Appearance Tab -->
                        <div x-show="detailsModal.tab === 'appearance'" class="space-y-6"
                             x-data="{
                                 motdInput: '',
                                 motdDirty: false,
                                 initMOTD() {
                                     this.motdInput = detailsModal.server?.MOTD || 'A Minecraft Server';
                                     this.motdDirty = false;
                                 },
                                 checkDirty() {
                                     this.motdDirty = this.motdInput !== (detailsModal.server?.MOTD || 'A Minecraft Server');
                                 }
                             }"
                             x-init="$watch('detailsModal.server', () => initMOTD())">
                            <div class="bg-gray-700 p-4 rounded-lg">
                                <h4 class="text-lg font-bold mb-4 flex items-center gap-2">
                                    <span>üí¨</span>
                                    <span>Server Description (MOTD)</span>
                                </h4>
                                <p class="text-sm text-gray-300 mb-3">
                                    The Message of the Day (MOTD) appears in the Minecraft server list.
                                    You can use Minecraft color codes (e.g., ¬ßa for green, ¬ßc for red).
                                </p>
                                <div class="flex gap-2">
                                    <input type="text"
                                           x-model="motdInput"
                                           @input="checkDirty()"
                                           placeholder="Enter server description"
                                           class="flex-1 px-4 py-2 bg-gray-600 text-white rounded focus:outline-none focus:ring-2 focus:ring-green-400"
                                           maxlength="512">
                                    <button @click="updateMOTD(detailsModal.server?.ID, motdInput); motdDirty = false; detailsModal.server.MOTD = motdInput"
                                            :disabled="!motdDirty"
                                            :class="motdDirty ? 'bg-green-500 hover:bg-green-600 cursor-pointer' : 'bg-gray-500 cursor-not-allowed opacity-50'"
                                            class="px-6 py-2 text-white rounded font-semibold transition-colors">
                                        Apply
                                    </button>
                                </div>
                                <div class="text-xs text-gray-400 mt-2">
                                    Max 512 characters. Changes apply after server restart.
                                </div>
                            </div>

                            <div class="bg-gray-700 p-4 rounded-lg">
                                <h4 class="text-lg font-bold mb-4 flex items-center gap-2">
                                    <span>üñºÔ∏è</span>
                                    <span>Server Icon</span>
                                </h4>
                                <p class="text-sm text-gray-300 mb-3">
                                    Upload a custom icon for your server (64x64 PNG recommended).
                                    This icon appears in the Minecraft server list.
                                </p>

                                <!-- Current Icon Preview -->
                                <div class="mb-4">
                                    <div class="text-sm font-semibold mb-2">Current Icon:</div>
                                    <img :src="`/api/servers/${detailsModal.server?.ID}/icon`"
                                         :alt="`${detailsModal.server?.Name} icon`"
                                         @error="$el.style.display='none'"
                                         class="w-32 h-32 rounded border-2 border-gray-600 object-cover">
                                    <div x-show="false" class="w-32 h-32 rounded border-2 border-gray-600 bg-gray-600 flex items-center justify-center text-4xl">
                                        üì¶
                                    </div>
                                </div>

                                <!-- Upload New Icon -->
                                <div class="space-y-2">
                                    <label class="block text-sm font-semibold">Upload New Icon (PNG, max 2MB):</label>
                                    <input type="file"
                                           accept="image/png"
                                           @change="uploadServerIcon(detailsModal.server?.ID, $event)"
                                           class="block w-full text-sm text-gray-400
                                                  file:mr-4 file:py-2 file:px-4
                                                  file:rounded file:border-0
                                                  file:text-sm file:font-semibold
                                                  file:bg-green-500 file:text-white
                                                  hover:file:bg-green-600
                                                  cursor-pointer">
                                    <div class="text-xs text-gray-400">
                                        Recommended: 64x64 pixels PNG image. Changes apply immediately.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Players Tab -->
                        <div x-show="detailsModal.tab === 'players'" class="space-y-4"
                             x-data="{
                                 activePlayerList: 'whitelist',
                                 whitelist: [],
                                 ops: [],
                                 bannedPlayers: [],
                                 newPlayerName: '',
                                 loading: false,
                                 async loadPlayerList(listType) {
                                     this.loading = true;
                                     try {
                                         const response = await fetch(`/api/servers/${detailsModal.server.ID}/players/${listType}`, {
                                             headers: { 'Authorization': `Bearer ${token}` }
                                         });
                                         if (response.ok) {
                                             const data = await response.json();
                                             this[listType] = data.players || [];
                                         }
                                     } catch (err) {
                                         console.error('Failed to load player list:', err);
                                     } finally {
                                         this.loading = false;
                                     }
                                 },
                                 async addPlayer(listType) {
                                     if (!this.newPlayerName.trim()) return;

                                     try {
                                         const response = await fetch(`/api/servers/${detailsModal.server.ID}/players/${listType}/add`, {
                                             method: 'POST',
                                             headers: {
                                                 'Authorization': `Bearer ${token}`,
                                                 'Content-Type': 'application/json'
                                             },
                                             body: JSON.stringify({ username: this.newPlayerName.trim() })
                                         });

                                         if (response.ok) {
                                             this.newPlayerName = '';
                                             await this.loadPlayerList(listType);
                                         } else {
                                             const error = await response.json();
                                             alert('Failed to add player: ' + error.error);
                                         }
                                     } catch (err) {
                                         alert('Failed to add player: ' + err.message);
                                     }
                                 },
                                 async removePlayer(listType, username) {
                                     if (!confirm(`Remove ${username} from ${listType}?`)) return;

                                     try {
                                         const response = await fetch(`/api/servers/${detailsModal.server.ID}/players/${listType}/${username}`, {
                                             method: 'DELETE',
                                             headers: { 'Authorization': `Bearer ${token}` }
                                         });

                                         if (response.ok) {
                                             await this.loadPlayerList(listType);
                                         } else {
                                             const error = await response.json();
                                             alert('Failed to remove player: ' + error.error);
                                         }
                                     } catch (err) {
                                         alert('Failed to remove player: ' + err.message);
                                     }
                                 }
                             }"
                             x-init="$watch('detailsModal.server', () => { if (detailsModal.server) { loadPlayerList('whitelist'); loadPlayerList('ops'); loadPlayerList('banned-players'); } })">

                            <!-- Player List Type Tabs -->
                            <div class="flex gap-2 border-b border-gray-700">
                                <button @click="activePlayerList = 'whitelist'; loadPlayerList('whitelist')"
                                        :class="activePlayerList === 'whitelist' ? 'border-blue-400 text-blue-400' : 'border-transparent'"
                                        class="px-4 py-2 border-b-2 transition">
                                    ‚úÖ Whitelist
                                </button>
                                <button @click="activePlayerList = 'ops'; loadPlayerList('ops')"
                                        :class="activePlayerList === 'ops' ? 'border-purple-400 text-purple-400' : 'border-transparent'"
                                        class="px-4 py-2 border-b-2 transition">
                                    üëë Operators
                                </button>
                                <button @click="activePlayerList = 'banned-players'; loadPlayerList('banned-players')"
                                        :class="activePlayerList === 'banned-players' ? 'border-red-400 text-red-400' : 'border-transparent'"
                                        class="px-4 py-2 border-b-2 transition">
                                    üö´ Banned
                                </button>
                            </div>

                            <!-- Whitelist Section -->
                            <div x-show="activePlayerList === 'whitelist'" class="space-y-4">
                                <div class="bg-gray-700 p-4 rounded-lg">
                                    <h4 class="text-lg font-bold mb-2 flex items-center gap-2">
                                        <span>‚úÖ</span>
                                        <span>Whitelist Management</span>
                                    </h4>
                                    <p class="text-sm text-gray-300 mb-4">
                                        Only whitelisted players can join the server. This is useful for private servers.
                                    </p>

                                    <!-- Add Player Form -->
                                    <div class="flex gap-2 mb-4">
                                        <input type="text"
                                               x-model="newPlayerName"
                                               @keyup.enter="addPlayer('whitelist')"
                                               placeholder="Enter player username"
                                               class="flex-1 px-4 py-2 bg-gray-600 text-white rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
                                        <button @click="addPlayer('whitelist')"
                                                :disabled="!newPlayerName.trim()"
                                                class="px-6 py-2 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-500 disabled:cursor-not-allowed text-white rounded font-semibold transition-colors">
                                            Add
                                        </button>
                                    </div>

                                    <!-- Player List -->
                                    <div class="space-y-2">
                                        <div class="text-sm font-semibold text-gray-400 mb-2">
                                            Whitelisted Players (<span x-text="whitelist.length"></span>):
                                        </div>
                                        <template x-for="player in whitelist" :key="player.uuid || player">
                                            <div class="flex items-center justify-between bg-gray-600 p-3 rounded">
                                                <span x-text="player.name || player" class="font-medium"></span>
                                                <button @click="removePlayer('whitelist', player.name || player)"
                                                        class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-sm rounded transition-colors">
                                                    Remove
                                                </button>
                                            </div>
                                        </template>
                                        <div x-show="whitelist.length === 0 && !loading" class="text-center py-8 text-gray-400">
                                            No whitelisted players yet
                                        </div>
                                        <div x-show="loading" class="text-center py-8 text-gray-400">
                                            Loading...
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Operators Section -->
                            <div x-show="activePlayerList === 'ops'" class="space-y-4">
                                <div class="bg-gray-700 p-4 rounded-lg">
                                    <h4 class="text-lg font-bold mb-2 flex items-center gap-2">
                                        <span>üëë</span>
                                        <span>Operator Management</span>
                                    </h4>
                                    <p class="text-sm text-gray-300 mb-4">
                                        Operators have administrator privileges on the server and can execute commands.
                                    </p>

                                    <!-- Add Player Form -->
                                    <div class="flex gap-2 mb-4">
                                        <input type="text"
                                               x-model="newPlayerName"
                                               @keyup.enter="addPlayer('ops')"
                                               placeholder="Enter player username"
                                               class="flex-1 px-4 py-2 bg-gray-600 text-white rounded focus:outline-none focus:ring-2 focus:ring-purple-400">
                                        <button @click="addPlayer('ops')"
                                                :disabled="!newPlayerName.trim()"
                                                class="px-6 py-2 bg-purple-500 hover:bg-purple-600 disabled:bg-gray-500 disabled:cursor-not-allowed text-white rounded font-semibold transition-colors">
                                            Add
                                        </button>
                                    </div>

                                    <!-- Player List -->
                                    <div class="space-y-2">
                                        <div class="text-sm font-semibold text-gray-400 mb-2">
                                            Operators (<span x-text="ops.length"></span>):
                                        </div>
                                        <template x-for="player in ops" :key="player.uuid || player">
                                            <div class="flex items-center justify-between bg-gray-600 p-3 rounded">
                                                <div class="flex items-center gap-2">
                                                    <span x-text="player.name || player" class="font-medium"></span>
                                                    <span x-show="player.level" x-text="'(Level ' + player.level + ')'" class="text-xs text-gray-400"></span>
                                                </div>
                                                <button @click="removePlayer('ops', player.name || player)"
                                                        class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-sm rounded transition-colors">
                                                    Remove
                                                </button>
                                            </div>
                                        </template>
                                        <div x-show="ops.length === 0 && !loading" class="text-center py-8 text-gray-400">
                                            No operators yet
                                        </div>
                                        <div x-show="loading" class="text-center py-8 text-gray-400">
                                            Loading...
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Banned Players Section -->
                            <div x-show="activePlayerList === 'banned-players'" class="space-y-4">
                                <div class="bg-gray-700 p-4 rounded-lg">
                                    <h4 class="text-lg font-bold mb-2 flex items-center gap-2">
                                        <span>üö´</span>
                                        <span>Banned Players</span>
                                    </h4>
                                    <p class="text-sm text-gray-300 mb-4">
                                        Banned players cannot join the server, even if whitelisted.
                                    </p>

                                    <!-- Add Player Form -->
                                    <div class="flex gap-2 mb-4">
                                        <input type="text"
                                               x-model="newPlayerName"
                                               @keyup.enter="addPlayer('banned-players')"
                                               placeholder="Enter player username"
                                               class="flex-1 px-4 py-2 bg-gray-600 text-white rounded focus:outline-none focus:ring-2 focus:ring-red-400">
                                        <button @click="addPlayer('banned-players')"
                                                :disabled="!newPlayerName.trim()"
                                                class="px-6 py-2 bg-red-500 hover:bg-red-600 disabled:bg-gray-500 disabled:cursor-not-allowed text-white rounded font-semibold transition-colors">
                                            Ban
                                        </button>
                                    </div>

                                    <!-- Player List -->
                                    <div class="space-y-2">
                                        <div class="text-sm font-semibold text-gray-400 mb-2">
                                            Banned Players (<span x-text="bannedPlayers.length"></span>):
                                        </div>
                                        <template x-for="player in bannedPlayers" :key="player.uuid || player">
                                            <div class="flex items-center justify-between bg-gray-600 p-3 rounded">
                                                <div class="flex flex-col">
                                                    <span x-text="player.name || player" class="font-medium"></span>
                                                    <span x-show="player.reason" x-text="'Reason: ' + player.reason" class="text-xs text-gray-400 mt-1"></span>
                                                </div>
                                                <button @click="removePlayer('banned-players', player.name || player)"
                                                        class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white text-sm rounded transition-colors">
                                                    Unban
                                                </button>
                                            </div>
                                        </template>
                                        <div x-show="bannedPlayers.length === 0 && !loading" class="text-center py-8 text-gray-400">
                                            No banned players
                                        </div>
                                        <div x-show="loading" class="text-center py-8 text-gray-400">
                                            Loading...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button @click="closeDetails()"
                            class="mt-4 w-full bg-gray-600 hover:bg-gray-500 text-white py-2 rounded">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function app() {
            return {
                // Connection state
                connectionStatus: 'connected', // 'connected' | 'reconnecting' | 'disconnected'
                consecutiveFailures: 0,
                lastSuccessfulRequest: Date.now(),
                connectionCheckInterval: null,

                // Auth state
                isAuthenticated: false,
                authTab: 'login',
                authError: '',
                loginForm: { email: '', password: '' },
                registerForm: { username: '', email: '', password: '' },
                user: null,
                token: null,

                // Server state
                servers: [],
                serverStatuses: {},
                loading: true,
                adminMode: false,  // Admin toggle for debugging
                newServer: {
                    name: '',
                    server_type: 'paper',
                    minecraft_version: '1.20.4',
                    ram_mb: 2048
                },
                detailsModal: {
                    show: false,
                    server: null,
                    tab: 'usage',
                    usageLogs: [],
                    backups: [],
                    plugins: [],
                    logs: '',
                    consoleLogs: [],
                    consoleConnected: false,
                    consoleWs: null
                },
                pluginSearch: '',
                availablePlugins: [],
                consoleCommand: '',
                commandHistory: [],
                historyIndex: -1,
                configForm: {
                    ram_mb: 2048,
                    minecraft_version: '',
                    max_players: 20
                },
                configApplying: false,
                configHistory: [],

                async init() {
                    // Check for stored token
                    this.token = localStorage.getItem('token');
                    if (this.token) {
                        await this.loadProfile();
                    }

                    // Start connection monitoring
                    this.startConnectionMonitoring();
                },

                // Connection monitoring methods
                startConnectionMonitoring() {
                    // Check connection every 10 seconds
                    this.connectionCheckInterval = setInterval(() => {
                        const timeSinceLastSuccess = Date.now() - this.lastSuccessfulRequest;

                        // If no successful request in last 30 seconds, check connection
                        if (timeSinceLastSuccess > 30000 && this.isAuthenticated) {
                            this.checkConnection();
                        }
                    }, 10000);
                },

                async checkConnection() {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000);

                        const response = await fetch('/health', {
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);

                        if (response.ok) {
                            this.markRequestSuccess();
                        } else {
                            this.markRequestFailure();
                        }
                    } catch (error) {
                        this.markRequestFailure();
                    }
                },

                markRequestSuccess() {
                    this.lastSuccessfulRequest = Date.now();
                    this.consecutiveFailures = 0;
                    if (this.connectionStatus !== 'connected') {
                        this.connectionStatus = 'connected';
                        console.log('‚úÖ Connection restored');
                    }
                },

                markRequestFailure() {
                    this.consecutiveFailures++;

                    if (this.consecutiveFailures >= 3) {
                        this.connectionStatus = 'disconnected';
                        console.error('‚ùå Connection lost after', this.consecutiveFailures, 'failures');
                    } else if (this.consecutiveFailures >= 1) {
                        this.connectionStatus = 'reconnecting';
                        console.warn('‚ö†Ô∏è Connection issues detected, attempt', this.consecutiveFailures);
                    }
                },

                // Auth methods
                async login() {
                    this.authError = '';
                    try {
                        const response = await fetch('/api/auth/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.loginForm)
                        });

                        if (response.ok) {
                            const data = await response.json();
                            this.token = data.token;
                            localStorage.setItem('token', this.token);
                            await this.loadProfile();
                            this.loginForm = { email: '', password: '' };
                        } else {
                            const error = await response.json();
                            this.authError = error.error || 'Login failed';
                        }
                    } catch (error) {
                        this.authError = 'Login failed: ' + error.message;
                    }
                },

                async register() {
                    this.authError = '';
                    try {
                        const response = await fetch('/api/auth/register', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.registerForm)
                        });

                        if (response.ok) {
                            const data = await response.json();
                            this.token = data.token;
                            localStorage.setItem('token', this.token);
                            await this.loadProfile();
                            this.registerForm = { username: '', email: '', password: '' };
                        } else {
                            const error = await response.json();
                            this.authError = error.error || 'Registration failed';
                        }
                    } catch (error) {
                        this.authError = 'Registration failed: ' + error.message;
                    }
                },

                async loadProfile() {
                    try {
                        const response = await this.apiCall('/api/auth/profile');

                        if (response.ok) {
                            const data = await response.json();
                            this.user = data.user;
                            this.isAuthenticated = true;
                            await this.loadServers();

                            // Auto-refresh
                            setInterval(() => {
                                this.loadServers();
                                this.loadServerStatuses();
                            }, 5000);
                        } else {
                            // Token invalid
                            this.logout();
                        }
                    } catch (error) {
                        console.error('Failed to load profile:', error);
                        // Don't logout on network errors, only on auth failures
                        if (this.consecutiveFailures < 3) {
                            // Keep trying to reconnect
                            setTimeout(() => this.loadProfile(), 5000);
                        }
                    }
                },

                logout() {
                    this.token = null;
                    this.user = null;
                    this.isAuthenticated = false;
                    this.servers = [];
                    localStorage.removeItem('token');
                },

                // API helper with connection tracking
                async apiCall(url, options = {}, timeout = 10000) {
                    try {
                        // Add timeout to detect hung connections
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), timeout);

                        const headers = {
                            'Authorization': `Bearer ${this.token}`,
                            ...options.headers
                        };

                        const response = await fetch(url, {
                            ...options,
                            headers,
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);

                        // Mark request as successful
                        this.markRequestSuccess();

                        // Check for authentication errors
                        if (response.status === 401) {
                            this.logout();
                            throw new Error('Session expired. Please login again.');
                        }

                        return response;
                    } catch (error) {
                        // Mark request as failed
                        this.markRequestFailure();

                        // Re-throw the error
                        throw error;
                    }
                },

                // Server methods
                async loadServers() {
                    if (!this.isAuthenticated) return;

                    try {
                        // Use admin endpoint if admin mode is enabled
                        const endpoint = this.adminMode ? '/api/admin/servers' : '/api/servers';
                        const response = await this.apiCall(endpoint);
                        if (response.ok) {
                            this.servers = await response.json();
                        }
                        this.loading = false;
                    } catch (error) {
                        console.error('Failed to load servers:', error);
                        this.loading = false;
                    }
                },

                async cleanOrphanedServers() {
                    if (!confirm('Clean all orphaned servers? This will delete servers with missing containers.')) return;

                    try {
                        const response = await this.apiCall('/api/admin/cleanup', { method: 'POST' });
                        if (response.ok) {
                            const result = await response.json();
                            alert(result.message + ' (count: ' + result.count + ')');
                            await this.loadServers();
                        } else {
                            const error = await response.json();
                            alert('Error: ' + error.error);
                        }
                    } catch (error) {
                        alert('Failed to clean servers: ' + error.message);
                    }
                },

                async loadServerStatuses() {
                    if (this.servers.length === 0) return;

                    for (const server of this.servers) {
                        if (server.Status === 'running') {
                            try {
                                const response = await this.apiCall(`/api/servers/${server.ID}/status`);
                                if (response.ok) {
                                    const status = await response.json();
                                    this.serverStatuses[server.ID] = status;
                                }
                            } catch (error) {
                                console.error(`Failed to load status for ${server.ID}:`, error);
                            }
                        }
                    }
                },

                async createServer() {
                    try {
                        const response = await this.apiCall('/api/servers', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.newServer)
                        });

                        if (response.ok) {
                            alert('Server created successfully!');
                            this.newServer.name = '';
                            await this.loadServers();
                            await this.loadProfile(); // Refresh balance
                        } else {
                            const error = await response.json();
                            alert('Error: ' + error.error);
                        }
                    } catch (error) {
                        alert('Failed to create server: ' + error.message);
                    }
                },

                async startServer(id) {
                    try {
                        // Use 90s timeout for server start (server initialization can take time)
                        const response = await this.apiCall(`/api/servers/${id}/start`, { method: 'POST' }, 90000);
                        if (response.ok) {
                            await this.loadServers();
                        }
                    } catch (error) {
                        alert('Failed to start server: ' + error.message);
                    }
                },

                async stopServer(id) {
                    try {
                        // Use 60s timeout for server stop (world save and graceful shutdown)
                        const response = await this.apiCall(`/api/servers/${id}/stop`, { method: 'POST' }, 60000);
                        if (response.ok) {
                            await this.loadServers();
                        }
                    } catch (error) {
                        alert('Failed to stop server: ' + error.message);
                    }
                },

                async restartServer(id) {
                    if (!confirm('Restart the server? This will stop and start the server.')) return;

                    try {
                        // Find the server to check its status
                        const server = this.servers.find(s => s.ID === id);

                        // If server is running, stop it first
                        if (server && server.Status === 'running') {
                            const stopResponse = await this.apiCall(`/api/servers/${id}/stop`, { method: 'POST' }, 60000);
                            if (!stopResponse.ok) {
                                const error = await stopResponse.json();
                                throw new Error(error.error || 'Failed to stop server');
                            }
                            // Wait a moment for clean shutdown
                            await new Promise(resolve => setTimeout(resolve, 2000));
                        }
                        // For servers in "error" state, skip stop and go directly to start
                        // The start API will clean up and recreate the container

                        // Start the server
                        const startResponse = await this.apiCall(`/api/servers/${id}/start`, { method: 'POST' }, 120000);
                        if (!startResponse.ok) {
                            const error = await startResponse.json();
                            throw new Error(error.error || 'Failed to start server');
                        }

                        await this.loadServers();
                        alert('Server restarted successfully!');
                    } catch (error) {
                        alert('Failed to restart server: ' + error.message);
                        // Reload servers anyway to get current status
                        await this.loadServers();
                    }
                },

                async deleteServer(id) {
                    if (!confirm('Are you sure you want to delete this server?')) return;

                    try {
                        const response = await this.apiCall(`/api/servers/${id}`, { method: 'DELETE' });
                        if (response.ok) {
                            await this.loadServers();
                        }
                    } catch (error) {
                        alert('Failed to delete server: ' + error.message);
                    }
                },

                async updateMOTD(serverId, newMOTD) {
                    if (!serverId || !newMOTD) return;

                    try {
                        const response = await this.apiCall(`/api/servers/${serverId}/motd`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ motd: newMOTD })
                        });

                        if (response.ok) {
                            alert('MOTD updated successfully! Restart the server for changes to take effect.');
                            // Update local server object
                            if (this.detailsModal.server && this.detailsModal.server.ID === serverId) {
                                this.detailsModal.server.MOTD = newMOTD;
                            }
                            await this.loadServers();
                        } else {
                            const error = await response.json();
                            throw new Error(error.error || 'Failed to update MOTD');
                        }
                    } catch (error) {
                        alert('Failed to update MOTD: ' + error.message);
                    }
                },

                async uploadServerIcon(serverId, event) {
                    const file = event.target.files[0];
                    if (!file || !serverId) return;

                    // Validate file
                    if (!file.type.startsWith('image/png')) {
                        alert('Please upload a PNG image');
                        event.target.value = '';
                        return;
                    }

                    if (file.size > 2 * 1024 * 1024) {
                        alert('File too large. Maximum size is 2MB');
                        event.target.value = '';
                        return;
                    }

                    try {
                        // Upload icon via file upload API
                        const formData = new FormData();
                        formData.append('file', file);
                        formData.append('type', 'server_icon');
                        formData.append('auto_activate', 'true');

                        const response = await this.apiCall(`/api/servers/${serverId}/uploads`, {
                            method: 'POST',
                            body: formData
                        }, 30000);

                        if (response.ok) {
                            alert('Server icon uploaded successfully! The icon will be visible immediately.');
                            // Reload all icon images for this server with timestamp to bypass cache
                            const timestamp = Date.now();
                            const iconImgs = document.querySelectorAll(`img[src*="/api/servers/${serverId}/icon"]`);
                            iconImgs.forEach(img => {
                                // Remove old timestamp query param if exists
                                const baseUrl = img.src.split('?')[0];
                                img.src = `${baseUrl}?t=${timestamp}`;
                            });
                            await this.loadServers();
                        } else {
                            const error = await response.json();
                            throw new Error(error.error || 'Failed to upload icon');
                        }
                    } catch (error) {
                        alert('Failed to upload icon: ' + error.message);
                    } finally {
                        event.target.value = '';
                    }
                },

                async viewDetails(server) {
                    this.detailsModal.server = server;
                    this.detailsModal.show = true;
                    this.detailsModal.tab = 'usage';

                    // Initialize config form with current values
                    this.configForm.ram_mb = server.RAMMb;
                    this.configForm.minecraft_version = server.MinecraftVersion;
                    this.configForm.server_type = server.ServerType;
                    this.configForm.max_players = server.MaxPlayers;
                    // Phase 1 Gameplay Settings
                    this.configForm.gamemode = server.Gamemode || 'survival';
                    this.configForm.difficulty = server.Difficulty || 'normal';
                    this.configForm.pvp = server.PVP !== undefined ? server.PVP : true;
                    this.configForm.enable_command_block = server.EnableCommandBlock || false;
                    this.configForm.level_seed = server.LevelSeed || '';
                    // Phase 2 Performance Settings
                    this.configForm.view_distance = server.ViewDistance || 10;
                    this.configForm.simulation_distance = server.SimulationDistance || 10;
                    // Phase 2 World Generation Settings
                    this.configForm.allow_nether = server.AllowNether !== undefined ? server.AllowNether : true;
                    this.configForm.allow_end = server.AllowEnd !== undefined ? server.AllowEnd : true;
                    this.configForm.generate_structures = server.GenerateStructures !== undefined ? server.GenerateStructures : true;
                    this.configForm.world_type = server.WorldType || 'default';
                    this.configForm.bonus_chest = server.BonusChest || false;
                    this.configForm.max_world_size = server.MaxWorldSize || 29999984;
                    // Phase 2 Spawn Settings
                    this.configForm.spawn_protection = server.SpawnProtection !== undefined ? server.SpawnProtection : 16;
                    this.configForm.spawn_animals = server.SpawnAnimals !== undefined ? server.SpawnAnimals : true;
                    this.configForm.spawn_monsters = server.SpawnMonsters !== undefined ? server.SpawnMonsters : true;
                    this.configForm.spawn_npcs = server.SpawnNPCs !== undefined ? server.SpawnNPCs : true;
                    // Phase 2 Network & Performance Settings
                    this.configForm.max_tick_time = server.MaxTickTime || 60000;
                    this.configForm.network_compression_threshold = server.NetworkCompressionThreshold || 256;
                    // Phase 4 Server Description (MOTD)
                    this.configForm.motd = server.MOTD || 'A Minecraft Server';

                    // Load usage logs
                    try {
                        const response = await this.apiCall(`/api/servers/${server.ID}/usage`);
                        if (response.ok) {
                            this.detailsModal.usageLogs = await response.json();
                        }
                    } catch (error) {
                        console.error('Failed to load usage:', error);
                    }

                    // Load backups
                    try {
                        const response = await this.apiCall(`/api/servers/${server.ID}/backups`);
                        if (response.ok) {
                            this.detailsModal.backups = await response.json();
                        }
                    } catch (error) {
                        console.error('Failed to load backups:', error);
                    }

                    // Load plugins (if applicable)
                    if (['paper', 'spigot', 'purpur'].includes(server.ServerType)) {
                        try {
                            const response = await this.apiCall(`/api/servers/${server.ID}/plugins`);
                            if (response.ok) {
                                this.detailsModal.plugins = await response.json();
                            }
                        } catch (error) {
                            console.error('Failed to load plugins:', error);
                        }
                    }

                    // Load logs
                    try {
                        const response = await this.apiCall(`/api/servers/${server.ID}/logs?tail=100`);
                        if (response.ok) {
                            const data = await response.json();
                            this.detailsModal.logs = data.logs || 'No logs available';
                        }
                    } catch (error) {
                        this.detailsModal.logs = 'Failed to load logs';
                    }

                    // Load configuration history
                    try {
                        const response = await this.apiCall(`/api/servers/${server.ID}/config/history`);
                        if (response.ok) {
                            const data = await response.json();
                            this.configHistory = data.history || [];
                        }
                    } catch (error) {
                        console.error('Failed to load config history:', error);
                        this.configHistory = [];
                    }
                },

                closeDetails() {
                    // Disconnect console WebSocket if connected
                    this.disconnectConsole();
                    this.detailsModal.show = false;
                    this.availablePlugins = [];
                },

                async createBackup(serverId) {
                    try {
                        const response = await this.apiCall(`/api/servers/${serverId}/backups`, { method: 'POST' });
                        if (response.ok) {
                            alert('Backup created successfully!');
                            const backupsResponse = await this.apiCall(`/api/servers/${serverId}/backups`);
                            if (backupsResponse.ok) {
                                this.detailsModal.backups = await backupsResponse.json();
                            }
                        }
                    } catch (error) {
                        alert('Failed to create backup: ' + error.message);
                    }
                },

                async restoreBackup(serverId, backupPath) {
                    if (!confirm('Restore from this backup? Current data will be replaced!')) return;

                    try {
                        const response = await this.apiCall(`/api/servers/${serverId}/backups/restore`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ backup_path: backupPath })
                        });
                        if (response.ok) {
                            alert('Backup restored successfully!');
                        }
                    } catch (error) {
                        alert('Failed to restore backup: ' + error.message);
                    }
                },

                async deleteBackup(serverId, filename) {
                    if (!confirm('Delete this backup?')) return;

                    try {
                        const response = await this.apiCall(`/api/servers/${serverId}/backups/${filename}`, { method: 'DELETE' });
                        if (response.ok) {
                            const backupsResponse = await this.apiCall(`/api/servers/${serverId}/backups`);
                            if (backupsResponse.ok) {
                                this.detailsModal.backups = await backupsResponse.json();
                            }
                        }
                    } catch (error) {
                        alert('Failed to delete backup: ' + error.message);
                    }
                },

                async searchPlugins() {
                    try {
                        const response = await this.apiCall(`/api/plugins/search?q=${encodeURIComponent(this.pluginSearch)}`);
                        if (response.ok) {
                            this.availablePlugins = await response.json();
                        }
                    } catch (error) {
                        alert('Failed to search plugins: ' + error.message);
                    }
                },

                async installPlugin(serverId, plugin) {
                    try {
                        const response = await this.apiCall(`/api/servers/${serverId}/plugins`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                plugin_url: plugin.download_url,
                                filename: `${plugin.name}.jar`
                            })
                        });
                        if (response.ok) {
                            alert(`${plugin.name} installed successfully!`);
                            const pluginsResponse = await this.apiCall(`/api/servers/${serverId}/plugins`);
                            if (pluginsResponse.ok) {
                                this.detailsModal.plugins = await pluginsResponse.json();
                            }
                        }
                    } catch (error) {
                        alert('Failed to install plugin: ' + error.message);
                    }
                },

                async removePlugin(serverId, filename) {
                    if (!confirm(`Remove ${filename}?`)) return;

                    try {
                        const response = await this.apiCall(`/api/servers/${serverId}/plugins/${filename}`, { method: 'DELETE' });
                        if (response.ok) {
                            const pluginsResponse = await this.apiCall(`/api/servers/${serverId}/plugins`);
                            if (pluginsResponse.ok) {
                                this.detailsModal.plugins = await pluginsResponse.json();
                            }
                        }
                    } catch (error) {
                        alert('Failed to remove plugin: ' + error.message);
                    }
                },

                // Console WebSocket methods
                connectConsole() {
                    if (this.detailsModal.consoleWs) {
                        return; // Already connected
                    }

                    const serverId = this.detailsModal.server?.ID;
                    if (!serverId) return;

                    // Clear previous logs
                    this.detailsModal.consoleLogs = [];

                    // Build WebSocket URL with token parameter
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${window.location.host}/api/servers/${serverId}/console/stream?token=${this.token}`;

                    console.log('Connecting to console:', wsUrl);

                    const ws = new WebSocket(wsUrl);
                    this.detailsModal.consoleWs = ws;

                    ws.onopen = () => {
                        console.log('Console WebSocket connected');
                        this.detailsModal.consoleConnected = true;
                    };

                    ws.onmessage = (event) => {
                        try {
                            const message = JSON.parse(event.data);
                            this.detailsModal.consoleLogs.push({
                                type: message.type,
                                content: message.content
                            });

                            // Auto-scroll to bottom
                            this.$nextTick(() => {
                                const output = this.$refs.consoleOutput;
                                if (output) {
                                    output.scrollTop = output.scrollHeight;
                                }
                            });
                        } catch (error) {
                            console.error('Failed to parse console message:', error);
                        }
                    };

                    ws.onerror = (error) => {
                        console.error('Console WebSocket error:', error);
                        this.detailsModal.consoleLogs.push({
                            type: 'error',
                            content: 'WebSocket connection error'
                        });
                    };

                    ws.onclose = () => {
                        console.log('Console WebSocket disconnected');
                        this.detailsModal.consoleConnected = false;
                        this.detailsModal.consoleWs = null;
                    };
                },

                disconnectConsole() {
                    if (this.detailsModal.consoleWs) {
                        this.detailsModal.consoleWs.close();
                        this.detailsModal.consoleWs = null;
                        this.detailsModal.consoleConnected = false;
                    }
                },

                sendCommand() {
                    const command = this.consoleCommand.trim();
                    if (!command || !this.detailsModal.consoleWs) return;

                    // Add to history
                    this.commandHistory.push(command);
                    this.historyIndex = -1;

                    // Display command in console
                    this.detailsModal.consoleLogs.push({
                        type: 'command',
                        content: command
                    });

                    // Send via WebSocket
                    this.detailsModal.consoleWs.send(JSON.stringify({
                        type: 'command',
                        content: command
                    }));

                    // Clear input
                    this.consoleCommand = '';

                    // Auto-scroll
                    this.$nextTick(() => {
                        const output = this.$refs.consoleOutput;
                        if (output) {
                            output.scrollTop = output.scrollHeight;
                        }
                    });
                },

                navigateHistory(direction) {
                    if (this.commandHistory.length === 0) return;

                    if (direction === -1) {
                        // Arrow up - go to previous command
                        if (this.historyIndex === -1) {
                            this.historyIndex = this.commandHistory.length - 1;
                        } else if (this.historyIndex > 0) {
                            this.historyIndex--;
                        }
                    } else if (direction === 1) {
                        // Arrow down - go to next command
                        if (this.historyIndex !== -1) {
                            this.historyIndex++;
                            if (this.historyIndex >= this.commandHistory.length) {
                                this.historyIndex = -1;
                                this.consoleCommand = '';
                                return;
                            }
                        }
                    }

                    if (this.historyIndex !== -1) {
                        this.consoleCommand = this.commandHistory[this.historyIndex];
                    }
                },

                async applyConfigChanges() {
                    if (this.configApplying) return;

                    const server = this.detailsModal.server;
                    if (!server) return;

                    // Build changes object (only include changed values)
                    const changes = {};

                    if (this.configForm.ram_mb !== server.RAMMb) {
                        changes.ram_mb = parseInt(this.configForm.ram_mb);
                    }

                    if (this.configForm.minecraft_version !== server.MinecraftVersion) {
                        changes.minecraft_version = this.configForm.minecraft_version;
                    }

                    if (this.configForm.server_type !== server.ServerType) {
                        changes.server_type = this.configForm.server_type;
                    }

                    if (this.configForm.max_players !== server.MaxPlayers) {
                        changes.max_players = parseInt(this.configForm.max_players);
                    }

                    // Phase 1 Gameplay Settings
                    if (this.configForm.gamemode !== (server.Gamemode || 'survival')) {
                        changes.gamemode = this.configForm.gamemode;
                    }

                    if (this.configForm.difficulty !== (server.Difficulty || 'normal')) {
                        changes.difficulty = this.configForm.difficulty;
                    }

                    const serverPVP = server.PVP !== undefined ? server.PVP : true;
                    if (this.configForm.pvp !== serverPVP) {
                        changes.pvp = this.configForm.pvp;
                    }

                    if (this.configForm.enable_command_block !== (server.EnableCommandBlock || false)) {
                        changes.enable_command_block = this.configForm.enable_command_block;
                    }

                    if (this.configForm.level_seed !== (server.LevelSeed || '')) {
                        changes.level_seed = this.configForm.level_seed;
                    }

                    // Phase 2 Performance Settings
                    if (this.configForm.view_distance !== (server.ViewDistance || 10)) {
                        changes.view_distance = parseInt(this.configForm.view_distance);
                    }

                    if (this.configForm.simulation_distance !== (server.SimulationDistance || 10)) {
                        changes.simulation_distance = parseInt(this.configForm.simulation_distance);
                    }

                    // Phase 2 World Generation Settings
                    const serverAllowNether = server.AllowNether !== undefined ? server.AllowNether : true;
                    if (this.configForm.allow_nether !== serverAllowNether) {
                        changes.allow_nether = this.configForm.allow_nether;
                    }

                    const serverAllowEnd = server.AllowEnd !== undefined ? server.AllowEnd : true;
                    if (this.configForm.allow_end !== serverAllowEnd) {
                        changes.allow_end = this.configForm.allow_end;
                    }

                    const serverGenerateStructures = server.GenerateStructures !== undefined ? server.GenerateStructures : true;
                    if (this.configForm.generate_structures !== serverGenerateStructures) {
                        changes.generate_structures = this.configForm.generate_structures;
                    }

                    if (this.configForm.world_type !== (server.WorldType || 'default')) {
                        changes.world_type = this.configForm.world_type;
                    }

                    if (this.configForm.bonus_chest !== (server.BonusChest || false)) {
                        changes.bonus_chest = this.configForm.bonus_chest;
                    }

                    if (this.configForm.max_world_size !== (server.MaxWorldSize || 29999984)) {
                        changes.max_world_size = parseInt(this.configForm.max_world_size);
                    }

                    // Phase 2 Spawn Settings
                    const serverSpawnProtection = server.SpawnProtection !== undefined ? server.SpawnProtection : 16;
                    if (this.configForm.spawn_protection !== serverSpawnProtection) {
                        changes.spawn_protection = parseInt(this.configForm.spawn_protection);
                    }

                    const serverSpawnAnimals = server.SpawnAnimals !== undefined ? server.SpawnAnimals : true;
                    if (this.configForm.spawn_animals !== serverSpawnAnimals) {
                        changes.spawn_animals = this.configForm.spawn_animals;
                    }

                    const serverSpawnMonsters = server.SpawnMonsters !== undefined ? server.SpawnMonsters : true;
                    if (this.configForm.spawn_monsters !== serverSpawnMonsters) {
                        changes.spawn_monsters = this.configForm.spawn_monsters;
                    }

                    const serverSpawnNPCs = server.SpawnNPCs !== undefined ? server.SpawnNPCs : true;
                    if (this.configForm.spawn_npcs !== serverSpawnNPCs) {
                        changes.spawn_npcs = this.configForm.spawn_npcs;
                    }

                    // Phase 2 Network & Performance Settings
                    if (this.configForm.max_tick_time !== (server.MaxTickTime || 60000)) {
                        changes.max_tick_time = parseInt(this.configForm.max_tick_time);
                    }

                    if (this.configForm.network_compression_threshold !== (server.NetworkCompressionThreshold || 256)) {
                        changes.network_compression_threshold = parseInt(this.configForm.network_compression_threshold);
                    }

                    // Phase 4 Server Description (MOTD)
                    if (this.configForm.motd !== (server.MOTD || 'A Minecraft Server')) {
                        changes.motd = this.configForm.motd;
                    }

                    // Check if there are any changes
                    if (Object.keys(changes).length === 0) {
                        alert('No changes detected');
                        return;
                    }

                    // Special warning for version changes
                    if (changes.minecraft_version) {
                        const oldVersion = server.MinecraftVersion;
                        const newVersion = changes.minecraft_version;

                        // Parse major version (e.g., "1.20.4" -> "1.20", "1.21.1" -> "1.21")
                        const oldMajor = oldVersion.split('.').slice(0, 2).join('.');
                        const newMajor = newVersion.split('.').slice(0, 2).join('.');

                        // Warn about downgrades
                        if (newMajor < oldMajor) {
                            if (!confirm(`‚ö†Ô∏è WARNING: Version Downgrade Detected!\n\nYou are downgrading from ${oldVersion} to ${newVersion}.\n\nThis will likely FAIL if your world was created with ${oldVersion}!\nMinecraft cannot load worlds from newer versions.\n\nOnly proceed if:\n- This is a fresh/new world\n- You have a backup from the older version\n\nContinue anyway?`)) {
                                return;
                            }
                        } else if (newMajor > oldMajor) {
                            // Info about upgrades
                            if (!confirm(`Version Upgrade: ${oldVersion} ‚Üí ${newVersion}\n\nThis should work, but always make sure you have backups!\n\nContinue?`)) {
                                return;
                            }
                        }
                    }

                    // Special warning for server type changes
                    if (changes.server_type) {
                        const oldType = server.ServerType;
                        const newType = changes.server_type;

                        let warningMessage = `Server Type Change: ${oldType} ‚Üí ${newType}\n\n`;

                        if (oldType === 'paper' && (newType === 'spigot' || newType === 'bukkit')) {
                            warningMessage += `‚ö†Ô∏è Paper-specific configs will be preserved but become inactive.\n\nPaper features like:\n- Paper-specific config files\n- Paper performance optimizations\n- Paper-only plugins\n\nWill no longer work until you switch back to Paper.\n\nWorld data remains safe and compatible.\n\nContinue?`;
                        } else if ((oldType === 'spigot' || oldType === 'bukkit') && newType === 'paper') {
                            warningMessage += `‚úÖ Switching to Paper!\n\nBenefits:\n- Better performance\n- More configuration options\n- Paper-specific features enabled\n\nYour world and plugins should work fine.\n\nContinue?`;
                        } else {
                            warningMessage += `Your world and most plugins should remain compatible.\n\nContinue?`;
                        }

                        if (!confirm(warningMessage)) {
                            return;
                        }
                    }

                    // Confirm changes
                    const changesList = Object.entries(changes)
                        .map(([key, value]) => `${key}: ${value}`)
                        .join('\n');

                    if (!confirm(`Apply the following configuration changes?\n\n${changesList}\n\nNote: Some changes may restart the server.`)) {
                        return;
                    }

                    this.configApplying = true;

                    try {
                        // Use 90s timeout for config changes (may trigger container recreate)
                        const response = await this.apiCall(`/api/servers/${server.ID}/config`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ changes })
                        }, 90000);

                        if (response.ok) {
                            const result = await response.json();
                            alert(`Configuration changes applied successfully!\n\nChange ID: ${result.change_id}\nStatus: ${result.status}\nRestart required: ${result.requires_restart ? 'Yes' : 'No'}`);

                            // Reload server data
                            await this.loadServers();

                            // Reload config history
                            const historyResponse = await this.apiCall(`/api/servers/${server.ID}/config/history`);
                            if (historyResponse.ok) {
                                const data = await historyResponse.json();
                                this.configHistory = data.history || [];
                            }

                            // Update the current server reference
                            const updatedServer = this.servers.find(s => s.ID === server.ID);
                            if (updatedServer) {
                                this.detailsModal.server = updatedServer;
                                this.configForm.ram_mb = updatedServer.RAMMb;
                                this.configForm.minecraft_version = updatedServer.MinecraftVersion;
                                this.configForm.server_type = updatedServer.ServerType;
                                this.configForm.max_players = updatedServer.MaxPlayers;
                            }
                        } else {
                            const error = await response.json();
                            alert(`Failed to apply configuration changes:\n${error.details || error.error}`);
                        }
                    } catch (error) {
                        console.error('Failed to apply config changes:', error);
                        alert('Failed to apply configuration changes: ' + error.message);
                    } finally {
                        this.configApplying = false;
                    }
                },

                formatDuration(seconds) {
                    const hours = Math.floor(seconds / 3600);
                    const minutes = Math.floor((seconds % 3600) / 60);
                    return `${hours}h ${minutes}m`;
                },

                formatSeconds(seconds) {
                    const mins = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    return `${mins}m ${secs}s`;
                },

                // Version-aware feature validation
                getAvailableGamemodes() {
                    if (!window.VersionFeatures) return [
                        { value: 'survival', label: 'Survival', enabled: true },
                        { value: 'creative', label: 'Creative', enabled: true },
                        { value: 'adventure', label: 'Adventure', enabled: true },
                        { value: 'spectator', label: 'Spectator', enabled: true }
                    ];

                    const version = this.configForm.minecraft_version || '1.8.9';
                    const serverType = this.configForm.server_type || 'paper';
                    return window.VersionFeatures.getAvailableGamemodes(version, serverType);
                },

                isGamemodeSupported(gamemode) {
                    if (!window.VersionFeatures || !gamemode) return true;

                    const version = this.configForm.minecraft_version || '1.8.9';
                    const feature = `gamemode_${gamemode}`;
                    return window.VersionFeatures.isFeatureSupported(feature, version);
                },

                getGamemodeWarning(gamemode) {
                    if (!window.VersionFeatures || !gamemode) return '';

                    const version = this.configForm.minecraft_version || '1.8.9';
                    const feature = `gamemode_${gamemode}`;
                    return window.VersionFeatures.getUnsupportedFeatureMessage(feature, version);
                },

                areCommandBlocksSupported() {
                    if (!window.VersionFeatures) return true;

                    const version = this.configForm.minecraft_version || '1.8.9';
                    return window.VersionFeatures.areCommandBlocksSupported(version);
                },

                areSeedsSupported() {
                    if (!window.VersionFeatures) return true;

                    const version = this.configForm.minecraft_version || '1.8.9';
                    return window.VersionFeatures.areSeedsSupported(version);
                },

                // Phase 2 Helper Functions
                getAvailableWorldTypes() {
                    if (!window.VersionFeatures) {
                        return [
                            { value: 'default', label: 'Default', enabled: true },
                            { value: 'flat', label: 'Superflat', enabled: true },
                            { value: 'largeBiomes', label: 'Large Biomes', enabled: true },
                            { value: 'amplified', label: 'Amplified', enabled: true }
                        ];
                    }

                    const version = this.configForm.minecraft_version || '1.8.9';
                    return window.VersionFeatures.getAvailableWorldTypes(version);
                },

                isSimulationDistanceSupported() {
                    if (!window.VersionFeatures) return true;

                    const version = this.configForm.minecraft_version || '1.8.9';
                    return window.VersionFeatures.isSimulationDistanceSupported(version);
                }
            }
        }
    </script>

    <script>
        // Initialize file upload UI render methods
        if (window.fileUploader && window.fileUploaderUI) {
            Object.assign(window.fileUploader, window.fileUploaderUI);
        }
    </script>

    <style>
        [x-cloak] { display: none !important; }
    </style>
</body>
</html>
